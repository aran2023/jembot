<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JemBot Controller (BLE)</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: 'Arial', sans-serif; text-align: center; background-color: #f4f7f6; margin: 0; user-select: none; }
        header { background: #28a745; color: white; padding: 15px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .status { margin: 10px; font-size: 0.9rem; color: #555; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 340px; margin: 20px auto; padding: 10px; }
        .btn { 
            aspect-ratio: 1; border: none; border-radius: 15px; font-size: 24px; font-weight: bold;
            background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.1s;
            display: flex; align-items: center; justify-content: center; color: #333;
        }
        .btn:active { background: #e2e6ea; transform: scale(0.95); box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        .connect-btn { background: #007bff; color: white; padding: 10px 30px; border: none; border-radius: 25px; font-size: 1rem; margin: 10px; }
        .stop { background-color: #ffc107; color: #000; }
        #log { font-size: 0.8rem; color: #888; margin-top: 20px; }
    </style>
</head>
<body>
    <header>JemBot PWA Controller üéÆ</header>
    
    <div class="status">
        <button class="connect-btn" onclick="connectBLE()">üì° Ï†¨Î¥á Ïó∞Í≤∞ÌïòÍ∏∞</button>
        <div id="connectionStatus">Ïó∞Í≤∞ ÎÅäÍπÄ</div>
    </div>

    <div class="grid">
        <button class="btn" onmousedown="sendCommand('7')" onmouseup="sendCommand('5')">‚Üñ</button>
        <button class="btn" onmousedown="sendCommand('8')" onmouseup="sendCommand('5')">‚ñ≤</button>
        <button class="btn" onmousedown="sendCommand('9')" onmouseup="sendCommand('5')">‚Üó</button>
        
        <button class="btn" onmousedown="sendCommand('4')" onmouseup="sendCommand('5')">‚óÄ</button>
        <button class="btn stop" onclick="sendCommand('5')">STOP</button>
        <button class="btn" onmousedown="sendCommand('6')" onmouseup="sendCommand('5')">‚ñ∂</button>
        
        <button class="btn" onmousedown="sendCommand('1')" onmouseup="sendCommand('5')">‚Üô</button>
        <button class="btn" onmousedown="sendCommand('2')" onmouseup="sendCommand('5')">‚ñº</button>
        <button class="btn" onmousedown="sendCommand('3')" onmouseup="sendCommand('5')">‚Üò</button>
    </div>

    <div id="log">Ï§ÄÎπÑ ÏôÑÎ£å</div>

    <script>
        // PWA Îì±Î°ù
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js'));
        }

        // Î∏îÎ£®Ìà¨Ïä§ ÏÑ§Ï†ï (ESP32 ÏΩîÎìúÏôÄ ÏùºÏπòÌï¥Ïïº Ìï®)
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const CHAR_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        let device, characteristic;

        async function connectBLE() {
            try {
                log("Ïû•Ïπò Í≤ÄÏÉâ Ï§ë...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'jembot0119' }], // ESP32 Ïù¥Î¶ÑÍ≥º ÎòëÍ∞ôÏïÑÏïº Ìï®!
                    optionalServices: [SERVICE_UUID]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHAR_UUID);

                document.getElementById('connectionStatus').innerText = "üü¢ Ïó∞Í≤∞Îê® (" + device.name + ")";
                document.querySelector('.connect-btn').style.display = 'none';
                log("Ïó∞Í≤∞ ÏÑ±Í≥µ!");
                
                // Ïó∞Í≤∞ÎêòÎ©¥ ÌòÑÏû¨ ÏãúÍ∞Ñ Ï†ÑÏÜ° (HHMM)
                const now = new Date();
                const timeStr = String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');
                sendCommand(timeStr); 

            } catch (error) {
                log("Ïó∞Í≤∞ Ïã§Ìå®: " + error);
            }
        }

        function sendCommand(cmd) {
            if (!characteristic) return;
            // ÌÖçÏä§Ìä∏Î•º Î∞îÏù¥Ìä∏Î°ú Î≥ÄÌôòÌïòÏó¨ Ï†ÑÏÜ°
            const encoder = new TextEncoder();
            characteristic.writeValue(encoder.encode(cmd))
                .catch(err => log("Ï†ÑÏÜ° Ïã§Ìå®: " + err));
        }

        function log(msg) {
            document.getElementById('log').innerText = msg;
            console.log(msg);
        }
    </script>
</body>
</html>
